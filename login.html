<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acceso | Control de Transportes BMM</title>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bmm-blue: #0d1c84;
            --bmm-blue-light: #1b2c9f;
            --text-dark: #111827;
            --muted: #4b5563;
            --danger: #b91c1c;
            --radius-lg: 18px;
            --shadow-soft: 0 18px 45px rgba(0, 0, 0, .35);
        }

        html,
        body {
            width: 100%;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            min-height: 100svh;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        @supports not (height:1svh) {
            body {
                min-height: 100dvh;
            }
        }

        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .bg-image {
            position: fixed;
            inset: 0;
            background: url("img/bf_img.jpg") center/cover no-repeat;
            z-index: -2;
            transform: scale(1.03);
            filter: brightness(.9) contrast(1.05) saturate(1.1);
        }

        .bg-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(to bottom, rgba(255, 255, 255, .08), rgba(0, 0, 0, .35));
            z-index: -1;
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 55px;
            background: var(--bmm-blue);
            color: #fff;
            display: flex;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .35);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .top-bar-inner {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-logo {
            height: 24px;
            object-fit: contain;
        }

        .top-btn-register {
            padding: .45rem 1.3rem;
            border-radius: 999px;
            border: 1px solid #fff;
            background: transparent;
            color: #fff;
            font-size: .9rem;
            font-weight: 600;
            letter-spacing: .04em;
            text-transform: uppercase;
            cursor: pointer;
        }

        .top-btn-register:hover {
            background: #fff;
            color: var(--bmm-blue);
            transform: translateY(-1px);
        }

        .login-wrapper {
            width: 100%;
            max-width: 420px;
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-card {
            width: 100%;
            border-radius: var(--radius-lg);
            padding: 2.1rem;
            background: rgba(255, 255, 255, .78);
            border: 1px solid rgba(255, 255, 255, .95);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.1rem;
            margin-top: 2.5rem;
        }

        .login-logo {
            width: 80px;
            object-fit: contain;
            display: block;
        }

        .login-title {
            font-size: 1.05rem;
            letter-spacing: .08em;
            text-transform: uppercase;
            text-align: center;
            color: var(--bmm-blue);
        }

        form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: .9rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: .3rem;
        }

        label {
            font-size: .85rem;
            font-weight: 600;
            letter-spacing: .04em;
            text-transform: uppercase;
            color: #374151;
        }

        .req-star::after {
            content: " *";
            color: #b91c1c;
            margin-left: .25rem;
        }

        .req-note {
            font-size: .8rem;
            color: #6b7280;
            margin-top: .25rem;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"] {
            width: 100%;
            padding: .7rem 2.4rem .7rem 1rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .9);
            background: #fff;
            font-size: .95rem;
            transition: .18s;
        }

        input:focus {
            border-color: var(--bmm-blue);
            box-shadow: 0 0 0 2px rgba(13, 28, 132, .3);
            outline: none;
        }

        .toggle-password {
            position: absolute;
            right: .85rem;
            top: 50%;
            translate: 0 -50%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-password img {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }

        .login-button {
            margin-top: .25rem;
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: .8rem 1rem;
            background: linear-gradient(135deg, var(--bmm-blue), var(--bmm-blue-light));
            color: #fff;
            font-weight: 600;
            letter-spacing: .06em;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(5, 12, 70, .7);
        }

        .helper-text {
            font-size: .72rem;
            color: var(--muted);
            text-align: center;
        }

        .error-message {
            font-size: .8rem;
            color: var(--danger);
            text-align: center;
            min-height: 1em;
        }

        .corner-logo {
            position: fixed;
            left: 1.2rem;
            bottom: calc(1.2rem + env(safe-area-inset-bottom));
            width: 95px;
            opacity: .9;
            object-fit: contain;
            z-index: 20;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
            padding-left: calc(1rem + env(safe-area-inset-left));
            padding-right: calc(1rem + env(safe-area-inset-right));
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal-card {
            width: clamp(320px, 96vw, 980px);
            height: min(92svh, 840px);
            max-height: 92svh;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 30px 70px rgba(0, 0, 0, .45);
            overflow: hidden;
            animation: pop .15s ease-out;
            display: grid;
            grid-template-rows: auto 1fr;
        }

        @supports not (height:1svh) {
            .modal-card {
                height: min(92dvh, 840px);
                max-height: 92dvh;
            }
        }

        @keyframes pop {
            from {
                transform: scale(.98);
                opacity: .6;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            z-index: 1;
            display: flex;
            align-items: center;
            gap: .75rem;
            padding: 1rem 1.25rem;
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        .modal-title {
            font-weight: 800;
            color: #1f2937;
            font-size: 1.25rem;
        }

        .subtle {
            color: #6b7280;
            font-size: .9rem;
        }

        .modal-body {
            padding: 1rem 1.25rem 1.25rem;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .row-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: .6rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width:640px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-grid>*,
        .row-1>* {
            min-width: 0;
            max-width: 100%;
        }

        select,
        .pill,
        textarea {
            width: 100%;
            padding: .8rem 1rem;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            background: #fff;
            font-size: 1rem;
        }

        .pill {
            border-radius: 999px;
        }

        .hint {
            font-size: .78rem;
            color: #64748b;
            margin-top: .25rem;
        }

        .invalid {
            border-color: #ef4444 !important;
        }

        .error {
            font-size: .8rem;
            color: #b91c1c;
            margin-top: .35rem;
        }

        .hidden {
            display: none !important;
        }

        .file-box {
            border: 1px dashed #9ca3af;
            border-radius: 14px;
            padding: 1.1rem;
            background: #fafafa;
            font-size: .95rem;
        }

        .file-box label {
            display: block;
            margin-bottom: .7rem;
            font-weight: 600;
            font-size: 1rem;
        }

        .file-box ul {
            margin: .4rem 0 0 1.25rem;
            line-height: 1.55;
        }

        .file-box li {
            margin: .12rem 0;
        }

        .lista-zip {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: .35rem 1.25rem;
            list-style: disc inside;
            padding-left: .25rem;
        }

        @media (max-width:520px) {
            .lista-zip {
                grid-template-columns: 1fr;
            }
        }

        .tabs {
            display: flex;
            gap: .5rem;
        }

        .tab-btn {
            padding: .5rem .9rem;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #fff;
            font-weight: 700;
            cursor: pointer;
            font-size: .9rem;
        }

        .tab-btn[aria-selected="true"] {
            background: var(--bmm-blue);
            color: #fff;
            border-color: var(--bmm-blue);
        }

        .tab-btn[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .actions-inline {
            display: flex;
            gap: .75rem;
            align-items: center;
        }

        .btn {
            border-radius: 10px;
            padding: .65rem 1rem;
            font-weight: 700;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--bmm-blue);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--bmm-blue-light);
        }

        .btn-ghost {
            background: #fff;
            border-color: #e5e7eb;
        }

        /* Botón cancelar rojo */
        .btn-cancel {
            background: #b91c1c;
            color: #fff;
            border-color: #b91c1c;
        }

        .btn-cancel:hover {
            background: #7f1d1d;
            border-color: #7f1d1d;
        }

        .row-role {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: .65rem 1rem;
        }

        .row-role>label {
            white-space: nowrap;
            font-weight: 700;
            letter-spacing: .03em;
        }

        @media (max-width:640px) {
            .row-role {
                grid-template-columns: 1fr;
                gap: .35rem;
            }
        }

        .grid-row-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width:640px) {
            .grid-row-actions {
                grid-template-columns: 1fr;
            }
        }

        .actions-left {
            justify-content: flex-start;
        }

        @media (max-width:400px) {
            .modal-header {
                padding: .75rem .9rem;
            }

            .modal-header img {
                width: 40px;
                height: 40px;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .modal-body {
                padding: .75rem .9rem 1rem;
            }

            label {
                font-size: .82rem;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="bg-image"></div>
    <div class="bg-overlay"></div>

    <header class="top-bar">
        <div class="top-bar-inner">
            <img src="img/logo_bf.png" alt="Logo BF" class="top-logo" />
            <button id="btnOpenRegister" class="top-btn-register" type="button">Registrarse</button>
        </div>
    </header>

    <main class="login-wrapper" aria-label="Acceso al sistema de control de transportes">
        <section class="login-card" role="form" aria-labelledby="titulo-login">
            <img src="img/tr_logo.gif" alt="logobf" class="login-logo" />
            <h1 id="titulo-login" class="login-title">Control de Transportes</h1>

            <form id="loginForm" novalidate autocomplete="off">
                <div class="form-group">
                    <label for="usuario">Usuario</label>
                    <div class="input-wrapper" style="position:relative">
                        <input id="usuario" name="usuario" type="text" inputmode="email" autocomplete="username"
                            placeholder="correo@empresa.com" required />
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <div class="input-wrapper" style="position:relative">
                        <input id="password" name="password" type="password" autocomplete="current-password"
                            placeholder="Ingresa tu contraseña" minlength="6" required />
                        <button type="button" class="toggle-password" id="btnTogglePassword"
                            aria-label="Mostrar u ocultar contraseña">
                            <img src="img/i_psw.png" alt="Mostrar contraseña" id="iconPassword">
                        </button>
                    </div>
                </div>

                <button type="submit" class="login-button" id="btnIngresar">Ingresar</button>
                <p class="helper-text">Acceso exclusivo para proveedores y personal autorizado</p>
                <div id="errorBox" class="error-message" aria-live="polite"></div>
            </form>
        </section>
    </main>

    <img src="img/d_logo.png" alt="Logo Digital Manufacturing" class="corner-logo" />

    <!-- ===== MODAL REGISTRO ===== -->
    <div id="modalRegister" class="modal-backdrop" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="reg-title">
            <div class="modal-header">
                <img id="regIcon" src="img/i_registro.png" alt="Registro" />
                <div>
                    <h2 id="reg-title" class="modal-title" tabindex="-1">Registro de Usuario</h2>
                    <p class="subtle">Completa la información según el rol.</p>
                </div>
            </div>

            <form id="registerForm" autocomplete="off">
                <div class="modal-body">
                    <div class="row-role">
                        <label for="regRol" class="req-star">Seleccionar rol</label>
                        <select id="regRol" required>
                            <option value="">Selecciona una opción</option>
                            <option value="Coordinador Logístico">Coordinador Logístico</option>
                            <option value="Proveedor">Proveedor</option>
                            <option value="Administrador">Administrador</option>
                        </select>
                        <div id="errRol" class="error hidden">Selecciona un rol.</div>
                    </div>

                    <!-- Admin / Logístico -->
                    <div id="sectionCorp" class="hidden">
                        <div class="form-grid">
                            <div>
                                <label for="regNomina" class="req-star">Nómina</label>
                                <input id="regNomina" type="text" class="pill" placeholder="Número de nómina" />
                                <div id="errNomina" class="error hidden">Campo obligatorio.</div>
                            </div>
                            <div>
                                <label for="regNombre" class="req-star">Nombre(s)</label>
                                <input id="regNombre" type="text" class="pill" placeholder="Nombre(s)" />
                                <div id="errNombre" class="error hidden">Campo obligatorio.</div>
                            </div>
                            <div>
                                <label for="regApellidos" class="req-star">Apellidos</label>
                                <input id="regApellidos" type="text" class="pill" placeholder="Apellidos" />
                                <div id="errApellidos" class="error hidden">Campo obligatorio.</div>
                            </div>
                            <div>
                                <label for="regCorreoOrg" class="req-star">Correo organizacional</label>
                                <input id="regCorreoOrg" type="email" class="pill"
                                    placeholder="usuario@Beiersdorf.com" />
                                <div class="hint">Debe ser dominio @Beiersdorf.com.</div>
                                <div id="errCorreoOrg" class="error hidden">Debe ser correo organizacional válido.</div>
                            </div>

                            <div class="actions-inline" style="grid-column:1 / -1;">
                                <button type="button" class="btn btn-cancel" id="btnCancelReg">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnSubmitReg">Registrarme</button>
                            </div>
                        </div>
                        <p class="req-note">* Campos obligatorios.</p>
                    </div>

                    <!-- Proveedor -->
                    <div id="sectionProvWrapper" class="hidden" aria-hidden="true">
                        <nav class="tabs" role="tablist" aria-label="Secciones de proveedor">
                            <button type="button" class="tab-btn" role="tab" id="tabDatos" aria-controls="panelDatos"
                                aria-selected="true">Datos</button>
                            <button type="button" class="tab-btn" role="tab" id="tabDoc" aria-controls="panelDoc"
                                aria-selected="false">Documentación</button>
                        </nav>

                        <div id="panelDatos" class="tab-panel active" role="tabpanel" aria-labelledby="tabDatos">
                            <div id="sectionProv">
                                <div class="form-grid">
                                    <div>
                                        <label for="provLinea" class="req-star">Línea transportista - Nombre
                                            comercial</label>
                                        <input id="provLinea" type="text" class="pill" />
                                        <div id="errProvLinea" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provRazon" class="req-star">Razón Social</label>
                                        <input id="provRazon" type="text" class="pill" />
                                        <div id="errProvRazon" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provFiscal" class="req-star">Dirección fiscal</label>
                                        <input id="provFiscal" type="text" class="pill" />
                                        <div id="errProvFiscal" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provPatios" class="req-star">Dirección de patios de maniobra</label>
                                        <input id="provPatios" type="text" class="pill" />
                                        <div id="errProvPatios" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provFrontera" class="req-star">Frontera por donde cruza</label>
                                        <input id="provFrontera" type="text" class="pill" />
                                        <div id="errProvFrontera" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provEmail" class="req-star">Contacto (Correo electrónico)</label>
                                        <input id="provEmail" type="email" class="pill"
                                            placeholder="Ingresar correo de contacto" />
                                        <div id="errProvEmail" class="error hidden">Correo válido requerido.</div>
                                    </div>

                                    <div class="grid-row-actions" style="grid-column:1 / -1;">
                                        <div>
                                            <label for="provTel" class="req-star">Contacto (Teléfono)</label>
                                            <input id="provTel" type="text" inputmode="numeric" pattern="\d{10}"
                                                maxlength="10" class="pill" placeholder="Ingresar número de contacto" />
                                            <div id="errProvTel" class="error hidden">Teléfono de 10 dígitos.</div>
                                        </div>
                                        <div class="actions-inline actions-left">
                                            <button type="button" class="btn btn-cancel"
                                                id="btnCancelReg2">Cancelar</button>
                                            <button type="submit" class="btn btn-primary"
                                                id="btnSubmitReg2">Registrarme</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="req-note">* Campos obligatorios.</p>
                        </div>

                        <div id="panelDoc" class="tab-panel" role="tabpanel" aria-labelledby="tabDoc">
                            <div class="row-1">
                                <div class="file-box">
                                    <label for="provZip"><strong>Adjuntar archivo ZIP (comprimido)</strong></label>
                                    <input id="provZip" type="file"
                                        accept=".zip,application/zip,application/x-zip-compressed" />
                                    <div class="hint i-info">Adjuntar un ZIP con:</div>
                                    <ul class="lista-zip">
                                        <li>Opinión positiva</li>
                                        <li>Opinión de cumplimiento de obligaciones fiscales</li>
                                        <li>Constancia de situación fiscal</li>
                                        <li>Copia de RFC (R1 y R2 si aplica)</li>
                                        <li>CAAT</li>
                                        <li>Comprobante de domicilio</li>
                                        <li>Poder e identificación del representante legal</li>
                                        <li>Certificación C-TPAT</li>
                                        <li>SUA mensual de operadores autorizados (último)</li>
                                        <li>Listado de transportistas autorizados</li>
                                        <li>Listado de unidades autorizadas</li>
                                    </ul>
                                    <div id="errProvZip" class="error hidden">El ZIP es obligatorio.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="regGlobalError" class="error hidden"></div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import {
            getFirestore, doc, runTransaction, setDoc,
            collection, getDocs, getDoc, query, where, limit
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2evTn_8bTrlEjc4d43UfljTQhDS3goXA",
            authDomain: "logisticatransportesbmm.firebaseapp.com",
            projectId: "logisticatransportesbmm",
            storageBucket: "logisticatransportesbmm.firebasestorage.app",
            messagingSenderId: "1096949784709",
            appId: "1:1096949784709:web:1eec7a8afca5c3278f49ec"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);

        const ROUTES = {
            UsuarioAdmin: "admin.html",
            UsuarioLogistico: "logistica.html",
            UsuarioProveedor: "proveedor.html",
        };

        const isBDF = email => /@beiersdorf\.com$/i.test((email || "").trim());

        async function getNextId(collectionName) {
            const counterRef = doc(db, "counters", collectionName);
            return await runTransaction(db, async tx => {
                const snap = await tx.get(counterRef);
                const current = snap.exists() ? (snap.data().seq || 0) : 0;
                const next = current + 1;
                tx.set(counterRef, { seq: next }, { merge: true });
                return next;
            });
        }

        /* ----------- LOGIN ----------- */
        const form = document.getElementById("loginForm");
        const btn = document.getElementById("btnIngresar");
        const errorBox = document.getElementById("errorBox");
        const passwordInput = document.getElementById("password");

        document.getElementById("btnTogglePassword").addEventListener("click", () => {
            const icon = document.getElementById("iconPassword");
            const isPass = passwordInput.type === "password";
            passwordInput.type = isPass ? "text" : "password";
            icon.src = isPass ? "img/v_psw.png" : "img/i_psw.png";
            icon.alt = isPass ? "Ocultar contraseña" : "Mostrar contraseña";
        });

        async function findUserInCollections(usuario, pass) {
            const collectionsToCheck = [
                { name: "UsuarioAdmin", roleKey: "UsuarioAdmin" },
                { name: "UsuarioLogistico", roleKey: "UsuarioLogistico" },
                { name: "UsuarioProveedor", roleKey: "UsuarioProveedor" },
            ];

            for (const c of collectionsToCheck) {
                const qRef = query(
                    collection(db, c.name),
                    where("usuario", "==", usuario),
                    where("contrasena", "==", pass),
                    limit(1)
                );
                const snap = await getDocs(qRef);
                if (!snap.empty) {
                    const docData = snap.docs[0].data();
                    return { data: docData, coll: c.name, roleKey: c.roleKey };
                }
            }
            return null;
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            errorBox.textContent = "";

            const usuario = (form.usuario.value || "").trim();
            const password = (form.password.value || "").trim();

            if (!usuario || !password) {
                errorBox.textContent = "Por favor ingresa usuario y contraseña.";
                return;
            }
            if (password.length < 6) {
                errorBox.textContent = "La contraseña debe tener al menos 6 caracteres.";
                return;
            }

            btn.disabled = true;
            try {
                const found = await findUserInCollections(usuario, password);
                if (!found) {
                    alert("Ingresa correctamente tu usuario o contraseña");
                    return;
                }

                const { data, roleKey } = found;
                const status = (data.estatus || "").toLowerCase();
                if (status !== "confirmado") {
                    alert("Su registro esta siendo validado");
                    return;
                }

                const go = ROUTES[roleKey] || "dashboard.html";
                window.location.href = go;

            } catch (err) {
                console.error(err);
                alert("Ocurrió un error al iniciar sesión. Intenta de nuevo.");
            } finally {
                btn.disabled = false;
            }
        });

        /* ----------- MODAL ----------- */
        const modal = document.getElementById("modalRegister");
        const regForm = document.getElementById("registerForm");
        const btnOpen = document.getElementById("btnOpenRegister");

        const regRol = document.getElementById("regRol");
        const sectionCorp = document.getElementById("sectionCorp");
        const sectionProvWrapper = document.getElementById("sectionProvWrapper");

        const tabDatos = document.getElementById("tabDatos");
        const tabDoc = document.getElementById("tabDoc");
        const panelDatos = document.getElementById("panelDatos");
        const panelDoc = document.getElementById("panelDoc");

        function activateTab(which) {
            if (which === "datos") {
                tabDatos.setAttribute("aria-selected", "true");
                tabDoc.setAttribute("aria-selected", "false");
                panelDatos.classList.add("active");
                panelDoc.classList.remove("active");
            } else {
                tabDatos.setAttribute("aria-selected", "false");
                tabDoc.setAttribute("aria-selected", "true");
                panelDatos.classList.remove("active");
                panelDoc.classList.add("active");
            }
            document.querySelector(".modal-card .modal-body").scrollTop = 0;
        }
        tabDatos.addEventListener("click", () => activateTab("datos"));
        tabDoc.addEventListener("click", () => activateTab("doc"));

        const setErr = (id, show, msg) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle("hidden", !show);
            if (msg) el.textContent = msg;
        };
        const resetErrors = () => {
            document.querySelectorAll(".error").forEach(e => e.classList.add("hidden"));
            document.querySelectorAll(".invalid").forEach(e => e.classList.remove("invalid"));
            setErr("regGlobalError", false, "");
        };

        const telInput = document.getElementById("provTel");
        telInput?.addEventListener("input", () => {
            const digits = (telInput.value || "").replace(/\D/g, "").slice(0, 10);
            telInput.value = digits;
        });

        function validateProviderBasic() {
            const v = id => document.getElementById(id).value.trim();
            const pairs = [
                ["provLinea", "errProvLinea"],
                ["provRazon", "errProvRazon"],
                ["provFiscal", "errProvFiscal"],
                ["provPatios", "errProvPatios"],
                ["provFrontera", "errProvFrontera"]
            ];
            let ok = true;
            for (const [fid, eid] of pairs) {
                const val = v(fid),
                    inp = document.getElementById(fid),
                    err = document.getElementById(eid);
                if (!val) { ok = false; err.classList.remove("hidden"); inp.classList.add("invalid"); }
                else { err.classList.add("hidden"); inp.classList.remove("invalid"); }
            }
            const email = v("provEmail");
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                ok = false;
                document.getElementById("errProvEmail").classList.remove("hidden");
                document.getElementById("provEmail").classList.add("invalid");
            } else {
                document.getElementById("errProvEmail").classList.add("hidden");
                document.getElementById("provEmail").classList.remove("invalid");
            }
            const tel = v("provTel");
            if (!/^\d{10}$/.test(tel)) {
                ok = false;
                document.getElementById("errProvTel").classList.remove("hidden");
                document.getElementById("provTel").classList.add("invalid");
            } else {
                document.getElementById("errProvTel").classList.add("hidden");
                document.getElementById("provTel").classList.remove("invalid");
            }
            return ok;
        }

        function attachLiveHide(selector, errorId) {
            const el = document.getElementById(selector);
            const err = document.getElementById(errorId);
            if (!el || !err) return;
            const hide = () => {
                if (el.classList.contains("invalid")) {
                    if (selector === "provEmail" && /^\S+@\S+\.\S+$/.test(el.value.trim())) {
                        err.classList.add("hidden");
                        el.classList.remove("invalid");
                    } else if (selector === "provTel" && /^\d{10}$/.test(el.value.trim())) {
                        err.classList.add("hidden");
                        el.classList.remove("invalid");
                    } else if (selector !== "provEmail" && selector !== "provTel" && el.value.trim()) {
                        err.classList.add("hidden");
                        el.classList.remove("invalid");
                    }
                }
            };
            el.addEventListener("input", hide);
            el.addEventListener("change", hide);
        }
        ["provLinea", "provRazon", "provFiscal", "provPatios", "provFrontera"].forEach(id =>
            attachLiveHide(id, "err" + id.charAt(0).toUpperCase() + id.slice(1))
        );
        attachLiveHide("provEmail", "errProvEmail");
        attachLiveHide("provTel", "errProvTel");

        function toggleSections(rol) {
            const isCorp = (rol === "Coordinador Logístico" || rol === "Administrador");
            const isProv = (rol === "Proveedor");
            sectionCorp.classList.toggle("hidden", !isCorp);
            sectionProvWrapper.classList.toggle("hidden", !isProv);
            sectionProvWrapper.setAttribute("aria-hidden", (!isProv).toString());
            const body = document.querySelector(".modal-card .modal-body");
            body.scrollTop = 0;
            if (isProv) {
                activateTab("datos");
                document.getElementById("provLinea")?.focus({ preventScroll: true });
            } else if (isCorp) {
                document.getElementById("regNomina")?.focus({ preventScroll: true });
            }
        }

        btnOpen?.addEventListener("click", () => {
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            document.getElementById("reg-title")?.focus?.({ preventScroll: true });
            toggleSections(regRol.value || "");
            regRol?.focus?.({ preventScroll: true });
        });

        function closeModal() {
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            regForm.reset();
            resetErrors();
            toggleSections("");
            activateTab("datos");
        }
        document.getElementById("btnCancelReg")?.addEventListener("click", closeModal);
        document.getElementById("btnCancelReg2")?.addEventListener("click", closeModal);

        regRol.addEventListener("change", (e) => toggleSections(e.target.value));
        document.addEventListener("DOMContentLoaded", () => toggleSections(regRol.value || ""));

        async function getAdminEmails() {
            const ids = ["-1", "-2"];
            const emails = [];
            for (const id of ids) {
                try {
                    const snap = await getDoc(doc(db, "UsuarioAdmin", id));
                    if (snap.exists()) {
                        const data = snap.data();
                        if (data.correo) emails.push(data.correo);
                    }
                } catch (err) {
                    console.warn("No se pudo leer UsuarioAdmin", id, err);
                }
            }
            return emails;
        }

        // ===== Registro: estatus Pendiente, usuario = correo, contraseña pendiente =====
        regForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            resetErrors();
            const rol = regRol.value;
            if (!rol) {
                setErr("errRol", true);
                return;
            }
            const submitBtn = e.submitter;
            if (submitBtn) submitBtn.disabled = true;

            try {
                // ----- Admin / Logístico -----
                if (rol === "Administrador" || rol === "Coordinador Logístico") {
                    const nomina = document.getElementById("regNomina").value.trim();
                    const nombre = document.getElementById("regNombre").value.trim();
                    const apellidos = document.getElementById("regApellidos").value.trim();
                    const correoOrg = document.getElementById("regCorreoOrg").value.trim();

                    let ok = true;
                    if (!nomina) { ok = false; setErr("errNomina", true); document.getElementById("regNomina").classList.add("invalid"); }
                    if (!nombre) { ok = false; setErr("errNombre", true); document.getElementById("regNombre").classList.add("invalid"); }
                    if (!apellidos) { ok = false; setErr("errApellidos", true); document.getElementById("regApellidos").classList.add("invalid"); }
                    if (!isBDF(correoOrg)) { ok = false; setErr("errCorreoOrg", true); document.getElementById("regCorreoOrg").classList.add("invalid"); }
                    if (!ok) {
                        if (submitBtn) submitBtn.disabled = false;
                        return;
                    }

                    const coll = (rol === "Administrador") ? "UsuarioAdmin" : "UsuarioLogistico";
                    const newId = await getNextId(coll);
                    await setDoc(doc(db, coll, String(newId)), {
                        id: newId,
                        rol,
                        nomina,
                        nombre,
                        apellidos,
                        correo: correoOrg,
                        estatus: "Pendiente",
                        usuario: correoOrg,
                        contrasena: null,
                        createdAt: new Date().toISOString()
                    });

                    // correo a admins -1, -2
                    try {
                        const adminEmails = await getAdminEmails();
                        const callable = httpsCallable(functions, "sendNewProviderEmail");
                        await callable({
                            providerId: newId,
                            providerEmail: correoOrg,
                            zipUrl: "",
                            adminEmails
                        });
                    } catch (mailErr) {
                        console.warn("Correo no enviado (admin/logístico):", mailErr?.message || mailErr);
                    }

                    alert("Registro enviado con éxito. Tu solicitud está pendiente de validación y se te notificará el acceso por correo electrónico.");
                    closeModal();
                } else if (rol === "Proveedor") {
                    // ----- Proveedor -----
                    const v = id => document.getElementById(id).value.trim();
                    const linea = v("provLinea"),
                        razon = v("provRazon"),
                        fiscal = v("provFiscal"),
                        patios = v("provPatios"),
                        frontera = v("provFrontera"),
                        email = v("provEmail"),
                        tel = v("provTel");
                    const zipInput = document.getElementById("provZip");
                    const zip = zipInput?.files?.[0];

                    let ok = validateProviderBasic();
                    if (!zip) {
                        ok = false;
                        setErr("errProvZip", true);
                    } else {
                        setErr("errProvZip", false);
                    }

                    if (!ok) {
                        alert("Revisa que todos los campos obligatorios y el archivo ZIP estén completos.");
                        if (submitBtn) submitBtn.disabled = false;
                        return;
                    }

                    let zipUrl = null;
                    try {
                        if (zip) {
                            const r = ref(storage, `proveedores_zips/${Date.now()}_${zip.name}`);
                            await uploadBytes(r, zip);
                            zipUrl = await getDownloadURL(r);
                        }
                    } catch (upErr) {
                        console.error("Error subiendo ZIP:", upErr);
                        setErr("regGlobalError", true, "Error al subir el archivo ZIP. Intenta de nuevo.");
                        if (submitBtn) submitBtn.disabled = false;
                        return;
                    }

                    try {
                        const newId = await getNextId("UsuarioProveedor");
                        await setDoc(doc(db, "UsuarioProveedor", String(newId)), {
                            id: newId,
                            rol: "Proveedor",
                            linea,
                            razon,
                            direccionFiscal: fiscal,
                            direccionPatios: patios,
                            frontera,
                            emailContacto: email,
                            telefonoContacto: tel,
                            zipPath: zipUrl || null,
                            estatus: "Pendiente",
                            usuario: email,
                            contrasena: null,
                            createdAt: new Date().toISOString()
                        });

                        // correo a admins -1, -2
                        try {
                            const adminEmails = await getAdminEmails();
                            const callable = httpsCallable(functions, "sendNewProviderEmail");
                            await callable({
                                providerId: newId,
                                providerEmail: email,
                                zipUrl: zipUrl || "",
                                adminEmails
                            });
                        } catch (mailErr) {
                            console.warn("Correo no enviado (proveedor):", mailErr?.message || mailErr);
                        }

                        alert("Registro enviado con éxito. Tu solicitud está pendiente de validación y se te notificará el acceso por correo electrónico.");
                        closeModal();
                    } catch (saveErr) {
                        console.error("Error guardando proveedor:", saveErr);
                        setErr("regGlobalError", true, "Ocurrió un error al registrar al proveedor. Intenta de nuevo.");
                    }
                }
            } catch (err) {
                console.error("Error general en registro:", err);
                setErr("regGlobalError", true, "Ocurrió un error al registrar. Intenta de nuevo.");
            } finally {
                if (submitBtn) submitBtn.disabled = false;
            }
        });
    </script>
</body>

</html>