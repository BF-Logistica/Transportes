<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acceso</title>

    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="img/icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="img/icon-512.png" sizes="512x512">

    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bmm-blue: #0d1c84;
            --bmm-blue-light: #1b2c9f;
            --text-dark: #111827;
            --muted: #4b5563;
            --danger: #b91c1c;
            --radius-lg: 18px;
            --shadow-soft: 0 18px 45px rgba(0, 0, 0, .35);
        }

        html,
        body {
            width: 100%;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            min-height: 100svh;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        @supports not (height:1svh) {
            body {
                min-height: 100dvh;
            }
        }

        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .bg-image {
            position: fixed;
            inset: 0;
            background: url("img/bf_img.jpg") center/cover no-repeat;
            z-index: -2;
            transform: scale(1.03);
            filter: brightness(.9) contrast(1.05) saturate(1.1);
        }

        .bg-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(to bottom, rgba(255, 255, 255, .08), rgba(0, 0, 0, .35));
            z-index: -1;
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 55px;
            background: var(--bmm-blue);
            color: #fff;
            display: flex;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .35);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .top-bar-inner {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-logo {
            height: 24px;
            object-fit: contain;
        }

        .top-btn-register {
            padding: .45rem 1.3rem;
            border-radius: 999px;
            border: 1px solid #fff;
            background: transparent;
            color: #fff;
            font-size: .9rem;
            font-weight: 600;
            letter-spacing: .04em;
            text-transform: uppercase;
            cursor: pointer;
        }

        .top-btn-register:hover {
            background: #fff;
            color: var(--bmm-blue);
            transform: translateY(-1px);
        }

        .login-wrapper {
            width: 100%;
            max-width: 420px;
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-card {
            width: 100%;
            border-radius: var(--radius-lg);
            padding: 2.1rem;
            background: rgba(255, 255, 255, .78);
            border: 1px solid rgba(255, 255, 255, .95);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.1rem;
            margin-top: 2.5rem;
        }

        .login-logo {
            width: 80px;
            object-fit: contain;
            display: block;
        }

        .login-title {
            font-size: 1.05rem;
            letter-spacing: .08em;
            text-transform: uppercase;
            text-align: center;
            color: var(--bmm-blue);
        }

        form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: .9rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: .3rem;
        }

        label {
            font-size: .85rem;
            font-weight: 600;
            letter-spacing: .04em;
            text-transform: uppercase;
            color: #374151;
        }

        .req-star::after {
            content: " *";
            color: #b91c1c;
            margin-left: .25rem;
        }

        .req-note {
            font-size: .8rem;
            color: #6b7280;
            margin-top: .25rem;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"] {
            width: 100%;
            padding: .7rem 2.4rem .7rem 1rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .9);
            background: #fff;
            font-size: .95rem;
            transition: .18s;
        }

        input:focus {
            border-color: var(--bmm-blue);
            box-shadow: 0 0 0 2px rgba(13, 28, 132, .3);
            outline: none;
        }

        .toggle-password {
            position: absolute;
            right: .85rem;
            top: 50%;
            translate: 0 -50%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-password img {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }

        .login-button {
            margin-top: .25rem;
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: .8rem 1rem;
            background: linear-gradient(135deg, var(--bmm-blue), var(--bmm-blue-light));
            color: #fff;
            font-weight: 600;
            letter-spacing: .06em;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(5, 12, 70, .7);
        }

        .helper-text {
            font-size: .72rem;
            color: var(--muted);
            text-align: center;
        }

        .error-message {
            font-size: .8rem;
            color: var(--danger);
            text-align: center;
            min-height: 1em;
        }

        .corner-logo {
            position: fixed;
            left: 1.2rem;
            bottom: calc(1.2rem + env(safe-area-inset-bottom));
            width: 95px;
            opacity: .9;
            object-fit: contain;
            z-index: 20;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
            padding-left: calc(1rem + env(safe-area-inset-left));
            padding-right: calc(1rem + env(safe-area-inset-right));
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal-card {
            width: clamp(320px, 96vw, 980px);
            height: min(92svh, 840px);
            max-height: 92svh;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 30px 70px rgba(0, 0, 0, .45);
            overflow: hidden;
            animation: pop .15s ease-out;
            display: grid;
            grid-template-rows: auto 1fr;
        }

        @supports not (height:1svh) {
            .modal-card {
                height: min(92dvh, 840px);
                max-height: 92dvh;
            }
        }

        @keyframes pop {
            from {
                transform: scale(.98);
                opacity: .6;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            z-index: 1;
            display: flex;
            align-items: center;
            gap: .75rem;
            padding: 1rem 1.25rem;
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        .modal-title {
            font-weight: 800;
            color: #1f2937;
            font-size: 1.25rem;
        }

        .subtle {
            color: #6b7280;
            font-size: .9rem;
        }

        .modal-body {
            padding: 1rem 1.25rem 1.25rem;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .row-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: .6rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width:640px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-grid>*,
        .row-1>* {
            min-width: 0;
            max-width: 100%;
        }

        select,
        .pill,
        textarea {
            width: 100%;
            padding: .8rem 1rem;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            background: #fff;
            font-size: 1rem;
        }

        .pill {
            border-radius: 999px;
        }

        .hint {
            font-size: .78rem;
            color: #64748b;
            margin-top: .25rem;
        }

        .invalid {
            border-color: #ef4444 !important;
        }

        .error {
            font-size: .8rem;
            color: #b91c1c;
            margin-top: .35rem;
        }

        .hidden {
            display: none !important;
        }

        .file-box {
            border: 1px dashed #9ca3af;
            border-radius: 14px;
            padding: 1.1rem;
            background: #fafafa;
            font-size: .95rem;
        }

        .file-box label {
            display: block;
            margin-bottom: .7rem;
            font-weight: 600;
            font-size: 1rem;
        }

        .file-box ul {
            margin: .4rem 0 0 1.25rem;
            line-height: 1.55;
        }

        .file-box li {
            margin: .12rem 0;
        }

        .lista-zip {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: .35rem 1.25rem;
            list-style: disc inside;
            padding-left: .25rem;
        }

        @media (max-width:520px) {
            .lista-zip {
                grid-template-columns: 1fr;
            }
        }

        .tabs {
            display: flex;
            gap: .5rem;
        }

        .tab-btn {
            padding: .5rem .9rem;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #fff;
            font-weight: 700;
            cursor: pointer;
            font-size: .9rem;
        }

        .tab-btn[aria-selected="true"] {
            background: var(--bmm-blue);
            color: #fff;
            border-color: var(--bmm-blue);
        }

        .tab-btn[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .actions-inline {
            display: flex;
            gap: .75rem;
            align-items: center;
        }

        .btn {
            border-radius: 10px;
            padding: .65rem 1rem;
            font-weight: 700;
            border: 1px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-loading {
            color: transparent !important;
            cursor: wait !important;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            inset: 0;
            margin: auto;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-top-color: rgba(255, 255, 255, 0.2);
            animation: spin .6s linear infinite;
        }

        .btn-ghost.btn-loading::after {
            border-color: var(--bmm-blue);
            border-top-color: rgba(13, 28, 132, 0.25);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-primary {
            background: var(--bmm-blue);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--bmm-blue-light);
        }

        .btn-ghost {
            background: #fff;
            border-color: #e5e7eb;
        }

        .btn-cancel {
            background: #b91c1c;
            border-color: #b91c1c;
            color: #fff;
        }

        .btn-cancel:hover {
            background: #991b1b;
            border-color: #991b1b;
        }

        .row-role {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: .65rem 1rem;
        }

        .row-role>label {
            white-space: nowrap;
            font-weight: 700;
            letter-spacing: .03em;
        }

        @media (max-width:640px) {
            .row-role {
                grid-template-columns: 1fr;
                gap: .35rem;
            }
        }

        .grid-row-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width:640px) {
            .grid-row-actions {
                grid-template-columns: 1fr;
            }
        }

        .actions-left {
            justify-content: flex-start;
        }

        @media (max-width:400px) {
            .modal-header {
                padding: .75rem .9rem;
            }

            .modal-header img {
                width: 40px;
                height: 40px;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .modal-body {
                padding: .75rem .9rem 1rem;
            }

            label {
                font-size: .82rem;
            }

            .btn {
                width: 100%;
            }
        }

        input.upper-text {
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div class="bg-image"></div>
    <div class="bg-overlay"></div>

    <header class="top-bar">
        <div class="top-bar-inner">
            <img src="img/logo_bf.png" alt="Logo BF" class="top-logo" />
            <button id="btnOpenRegister" class="top-btn-register" type="button">Registrarse</button>
        </div>
    </header>

    <main class="login-wrapper" aria-label="Acceso al sistema de control de transportes">
        <section class="login-card" role="form" aria-labelledby="titulo-login">
            <img src="img/tr_logo.gif" alt="logobf" class="login-logo" />
            <h1 id="titulo-login" class="login-title">Control de Transportes</h1>

            <form id="loginForm" novalidate autocomplete="off">
                <div class="form-group">
                    <label for="usuario">Usuario</label>
                    <div class="input-wrapper" style="position:relative">
                        <input id="usuario" name="usuario" type="text" inputmode="email" autocomplete="username"
                            placeholder="correo@empresa.com" required />
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <div class="input-wrapper" style="position:relative">
                        <input id="password" name="password" type="password" autocomplete="current-password"
                            placeholder="Ingresa tu contraseña" minlength="6" required />
                        <button type="button" class="toggle-password" id="btnTogglePassword"
                            aria-label="Mostrar u ocultar contraseña">
                            <img src="img/i_psw.png" alt="Mostrar contraseña" id="iconPassword">
                        </button>
                    </div>
                </div>

                <button type="submit" class="login-button" id="btnIngresar">Ingresar</button>
                <p class="helper-text">Acceso exclusivo para proveedores y personal autorizado</p>
                <div id="errorBox" class="error-message" aria-live="polite"></div>
            </form>
        </section>
    </main>

    <img src="img/d_logo.png" alt="Logo Digital Manufacturing" class="corner-logo" />

    <div id="modalRegister" class="modal-backdrop" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="reg-title">
            <div class="modal-header">
                <img id="regIcon" src="img/i_registro.png" alt="Registro" />
                <div>
                    <h2 id="reg-title" class="modal-title" tabindex="-1">Registro de Usuario</h2>
                    <p class="subtle">Completa la información según el rol.</p>
                </div>
            </div>

            <form id="registerForm" autocomplete="off">
                <div class="modal-body">
                    <div class="row-role">
                        <label for="regRol" class="req-star">Seleccionar rol</label>
                        <select id="regRol" required>
                            <option value="">Selecciona una opción</option>
                            <option value="Coordinador Logístico">Coordinador Logístico</option>
                            <option value="Proveedor">Proveedor</option>
                            <option value="Administrador">Administrador</option>
                        </select>
                        <div id="errRol" class="error hidden">Selecciona un rol.</div>
                    </div>

                    <div id="sectionCorp" class="hidden">
                        <div class="form-grid">
                            <div>
                                <label for="regNomina" class="req-star">Nómina</label>
                                <input id="regNomina" type="text" class="pill upper-text"
                                    placeholder="Número de nómina" />
                                <div id="errNomina" class="error hidden">Campo obligatorio.</div>
                            </div>
                            <div>
                                <label for="regNombre" class="req-star">Nombre(s)</label>
                                <input id="regNombre" type="text" class="pill upper-text" />
                                <div id="errNombre" class="error hidden">Campo obligatorio.</div>
                            </div>
                            <div>
                                <label for="regApellidos" class="req-star">Apellidos</label>
                                <input id="regApellidos" type="text" class="pill upper-text" />
                                <div id="errApellidos" class="error hidden">Campo obligatorio.</div>
                            </div>
                            <div>
                                <label for="regCorreoOrg" class="req-star">Correo organizacional</label>
                                <input id="regCorreoOrg" type="email" class="pill"
                                    placeholder="usuario@Beiersdorf.com" />
                                <div class="hint">Debe ser dominio @Beiersdorf.com.</div>
                                <div id="errCorreoOrg" class="error hidden">Debe ser correo organizacional válido.
                                </div>
                            </div>

                            <div class="actions-inline" style="grid-column:1 / -1;">
                                <button type="button" class="btn btn-cancel" id="btnCancelReg">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnSubmitReg">Registrarme</button>
                            </div>
                        </div>
                        <p class="req-note">* Campos obligatorios.</p>
                    </div>

                    <div id="sectionProvWrapper" class="hidden" aria-hidden="true">
                        <nav class="tabs" role="tablist" aria-label="Secciones de proveedor">
                            <button type="button" class="tab-btn" role="tab" id="tabDatos" aria-controls="panelDatos"
                                aria-selected="true">Datos</button>
                            <button type="button" class="tab-btn" role="tab" id="tabDoc" aria-controls="panelDoc"
                                aria-selected="false" disabled>Documentación</button>
                        </nav>

                        <div id="panelDatos" class="tab-panel active" role="tabpanel" aria-labelledby="tabDatos">
                            <div id="sectionProv">
                                <div class="form-grid">
                                    <div>
                                        <label for="provLinea" class="req-star">Línea transportista - Nombre
                                            comercial</label>
                                        <input id="provLinea" type="text" class="pill upper-text" />
                                        <div id="errProvLinea" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provRazon" class="req-star">Razón Social</label>
                                        <input id="provRazon" type="text" class="pill upper-text" />
                                        <div id="errProvRazon" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provFiscal" class="req-star">Dirección fiscal</label>
                                        <input id="provFiscal" type="text" class="pill upper-text" />
                                        <div id="errProvFiscal" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provPatios" class="req-star">Dirección de patios de maniobra</label>
                                        <input id="provPatios" type="text" class="pill upper-text" />
                                        <div id="errProvPatios" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provFrontera" class="req-star">Frontera por donde cruza</label>
                                        <input id="provFrontera" type="text" class="pill upper-text" />
                                        <div id="errProvFrontera" class="error hidden">Campo obligatorio.</div>
                                    </div>
                                    <div>
                                        <label for="provEmail" class="req-star">Contacto (Correo electrónico)</label>
                                        <input id="provEmail" type="email" class="pill"
                                            placeholder="Ingresar correo de contacto" />
                                        <div id="errProvEmail" class="error hidden">Correo válido requerido.</div>
                                    </div>

                                    <div class="grid-row-actions" style="grid-column:1 / -1;">
                                        <div>
                                            <label for="provTel" class="req-star">Contacto (Teléfono)</label>
                                            <input id="provTel" type="text" inputmode="numeric" pattern="\d{10}"
                                                maxlength="10" class="pill" placeholder="Ingresar número de contacto" />
                                            <div id="errProvTel" class="error hidden">Teléfono de 10 dígitos.</div>
                                        </div>
                                        <div class="actions-inline actions-left">
                                            <button type="button" class="btn btn-cancel"
                                                id="btnCancelReg2">Cancelar</button>
                                            <button type="submit" class="btn btn-primary"
                                                id="btnSubmitReg2">Registrarme</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="req-note">* Campos obligatorios.</p>
                        </div>

                        <div id="panelDoc" class="tab-panel" role="tabpanel" aria-labelledby="tabDoc">
                            <div class="row-1">
                                <div class="file-box">
                                    <label for="provZip"><strong>Adjuntar archivo ZIP (comprimido)</strong></label>
                                    <input id="provZip" type="file" accept=".zip" />
                                    <div class="hint i-info">Adjuntar un ZIP con la documentación requerida.</div>

                                    <ul class="lista-zip">
                                        <li>Opinión positiva</li>
                                        <li>Opinión de cumplimiento de obligaciones fiscales</li>
                                        <li>Constancia de situación fiscal</li>
                                        <li>Copia de RFC (R1 y R2 si aplica)</li>
                                        <li>CAAT</li>
                                        <li>Comprobante de domicilio</li>
                                        <li>Poder e identificación del representante legal</li>
                                        <li>Certificación C-TPAT</li>
                                        <li>SUA mensual de operadores autorizados (último)</li>
                                        <li>Listado de transportistas autorizados</li>
                                        <li>Listado de unidades autorizadas</li>
                                    </ul>

                                    <div id="errProvZip" class="error hidden">El ZIP es obligatorio.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="regGlobalError" class="error hidden"></div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import {
            getFirestore, doc, runTransaction, setDoc,
            collection, getDocs, query, where, limit
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2evTn_8bTrlEjc4d43UfljTQhDS3goXA",
            authDomain: "logisticatransportesbmm.firebaseapp.com",
            projectId: "logisticatransportesbmm",
            storageBucket: "logisticatransportesbmm.firebasestorage.app",
            messagingSenderId: "1096949784709",
            appId: "1:1096949784709:web:1eec7a8afca5c3278f49ec"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const APPS_SCRIPT_URL =
              "https://script.google.com/macros/s/AKfycbyVL4i0PfAYEbiSwcmKZ0ZXST1T3L-8H0lK5CbEVJRnimZaKNDtwMWLApiIStm3Wgz6ZQ/exec";

        const ROUTES = {
            UsuarioAdmin: "menu.html",
            UsuarioLogistico: "control.html",
            UsuarioProveedor: "agendarcita.html"
        };
        // Redirección según rol: Administrador → index.html, Proveedor → calendario.html, Coordinador Logístico → menu.html

        const isBDF = email => /@beiersdorf\.com$/i.test((email || "").trim());

        async function getNextId(collectionName) {
            const counterRef = doc(db, "counters", collectionName);
            return await runTransaction(db, async tx => {
                const snap = await tx.get(counterRef);
                const current = snap.exists() ? (snap.data().seq || 0) : 0;
                const next = current + 1;
                tx.set(counterRef, { seq: next }, { merge: true });
                return next;
            });
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result || "";
                    const parts = String(result).split(",");
                    resolve(parts[1] || "");
                };
                reader.onerror = err => reject(err);
                reader.readAsDataURL(file);
            });
        }

        const form = document.getElementById("loginForm");
        const btn = document.getElementById("btnIngresar");
        const errorBox = document.getElementById("errorBox");
        const passwordInput = document.getElementById("password");

        document.getElementById("btnTogglePassword").addEventListener("click", () => {
            const icon = document.getElementById("iconPassword");
            const isPass = passwordInput.type === "password";
            passwordInput.type = isPass ? "text" : "password";
            icon.src = isPass ? "img/v_psw.png" : "img/i_psw.png";
            icon.alt = isPass ? "Ocultar contraseña" : "Mostrar contraseña";
        });

        async function findUserInCollections(usuarioLower, pass) {
            const collectionsToCheck = [
                { name: "UsuarioAdmin", roleKey: "UsuarioAdmin" },
                { name: "UsuarioLogistico", roleKey: "UsuarioLogistico" },
                { name: "UsuarioProveedor", roleKey: "UsuarioProveedor" }
            ];

            for (const c of collectionsToCheck) {
                const qRef = query(
                    collection(db, c.name),
                    where("usuario", "==", usuarioLower),
                    where("contrasena", "==", pass),
                    limit(1)
                );
                const snap = await getDocs(qRef);
                if (!snap.empty) {
                    const docData = snap.docs[0].data();
                    return { data: docData, coll: c.name, roleKey: c.roleKey };
                }
            }
            return null;
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            errorBox.textContent = "";

            const usuarioInput = (form.usuario.value || "").trim();
            const password = (form.password.value || "").trim();
            const usuarioLower = usuarioInput.toLowerCase();

            if (!usuarioLower || !password) {
                errorBox.textContent = "Por favor ingresa usuario y contraseña.";
                return;
            }
            if (password.length < 6) {
                errorBox.textContent = "La contraseña debe tener al menos 6 caracteres.";
                return;
            }

            btn.disabled = true;
            btn.classList.add("btn-loading");

            try {
                const found = await findUserInCollections(usuarioLower, password);
                if (!found) {
                    alert("Ingresa correctamente tu usuario o contraseña");
                    return;
                }

                const { data, roleKey, coll } = found;
                const status = (data.estatus || "").toLowerCase();
                if (status !== "confirmado") {
                    alert("Su registro está siendo validado");
                    return;
                }

                // ----- AQUÍ construimos y guardamos el usuario en sesión -----
                const rolNormalizado =
                    data.rol ||
                    (roleKey === "UsuarioAdmin"
                        ? "Administrador"
                        : roleKey === "UsuarioLogistico"
                            ? "Coordinador Logístico"
                            : "Proveedor");

                const currentUser = {
                    id: data.id ?? null,
                    collection: coll,          // UsuarioAdmin / UsuarioLogistico / UsuarioProveedor
                    roleKey,                   // misma clave que usas en ROUTES
                    rol: rolNormalizado,       // ← OJO: aquí queda "Coordinador Logístico" igual que en Firestore
                    usuario: data.usuario || usuarioLower,
                    correo: data.correo || data.emailContacto || usuarioLower,
                    nomina: data.nomina || null,
                    nombre: data.nombre || null,
                    apellidos: data.apellidos || null,
                    estatus: data.estatus || "Confirmado"
                };

                try {
                    sessionStorage.setItem("currentUser", JSON.stringify(currentUser));
                    // opcional: también en localStorage si quieres que persista entre pestañas
                    localStorage.setItem("currentUser", JSON.stringify(currentUser));
                } catch (storageErr) {
                    console.warn("No se pudo guardar currentUser en storage:", storageErr);
                }
                // -------------------------------------------------------------

                const go = ROUTES[roleKey] || "index.html";
                window.location.href = go;

            } catch (err) {
                console.error(err);
                alert("Ocurrió un error al iniciar sesión. Intenta de nuevo.");
            } finally {
                btn.disabled = false;
                btn.classList.remove("btn-loading");
            }
        });

        const modal = document.getElementById("modalRegister");
        const regForm = document.getElementById("registerForm");
        const btnOpen = document.getElementById("btnOpenRegister");

        const regRol = document.getElementById("regRol");
        const sectionCorp = document.getElementById("sectionCorp");
        const sectionProvWrapper = document.getElementById("sectionProvWrapper");
        const sectionProv = document.getElementById("sectionProv");

        const tabDatos = document.getElementById("tabDatos");
        const tabDoc = document.getElementById("tabDoc");
        const panelDatos = document.getElementById("panelDatos");
        const panelDoc = document.getElementById("panelDoc");
        let lockDocTab = true;

        function activateTab(which) {
            if (which === "datos") {
                tabDatos.setAttribute("aria-selected", "true");
                tabDoc.setAttribute("aria-selected", "false");
                panelDatos.classList.add("active");
                panelDoc.classList.remove("active");
            } else {
                if (lockDocTab) return;
                tabDatos.setAttribute("aria-selected", "false");
                tabDoc.setAttribute("aria-selected", "true");
                panelDatos.classList.remove("active");
                panelDoc.classList.add("active");
            }
            document.querySelector(".modal-card .modal-body").scrollTop = 0;
        }
        tabDatos.addEventListener("click", () => activateTab("datos"));
        tabDoc.addEventListener("click", () => activateTab("doc"));

        const setErr = (id, show, msg) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle("hidden", !show);
            if (msg) el.textContent = msg;
        };
        const resetErrors = () => {
            document.querySelectorAll(".error").forEach(e => e.classList.add("hidden"));
            document.querySelectorAll(".invalid").forEach(e => e.classList.remove("invalid"));
            setErr("regGlobalError", false, "");
        };

        const telInput = document.getElementById("provTel");
        telInput?.addEventListener("input", () => {
            const digits = (telInput.value || "").replace(/\D/g, "").slice(0, 10);
            telInput.value = digits;
        });

        function validateProviderBasic() {
            const v = id => document.getElementById(id).value.trim();
            const pairs = [
                ["provLinea", "errProvLinea"],
                ["provRazon", "errProvRazon"],
                ["provFiscal", "errProvFiscal"],
                ["provPatios", "errProvPatios"],
                ["provFrontera", "errProvFrontera"]
            ];
            let ok = true;
            for (const [fid, eid] of pairs) {
                const val = v(fid), inp = document.getElementById(fid), err = document.getElementById(eid);
                if (!val) { ok = false; err.classList.remove("hidden"); inp.classList.add("invalid"); }
                else { err.classList.add("hidden"); inp.classList.remove("invalid"); }
            }
            const email = v("provEmail");
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                ok = false;
                document.getElementById("errProvEmail").classList.remove("hidden");
                document.getElementById("provEmail").classList.add("invalid");
            } else {
                document.getElementById("errProvEmail").classList.add("hidden");
                document.getElementById("provEmail").classList.remove("invalid");
            }
            const tel = v("provTel");
            if (!/^\d{10}$/.test(tel)) {
                ok = false;
                document.getElementById("errProvTel").classList.remove("hidden");
                document.getElementById("provTel").classList.add("invalid");
            } else {
                document.getElementById("errProvTel").classList.add("hidden");
                document.getElementById("provTel").classList.remove("invalid");
            }
            return ok;
        }
        function isProviderBasicValidSilent() {
            const get = id => document.getElementById(id)?.value.trim();
            const fields = ["provLinea", "provRazon", "provFiscal", "provPatios", "provFrontera"];
            if (fields.some(f => !get(f))) return false;
            if (!/^\S+@\S+\.\S+$/.test(get("provEmail") || "")) return false;
            if (!/^\d{10}$/.test(get("provTel") || "")) return false;
            return true;
        }
        function attachLiveHide(selector, errorId) {
            const el = document.getElementById(selector);
            const err = document.getElementById(errorId);
            if (!el || !err) return;
            const hide = () => {
                if (el.classList.contains("invalid")) {
                    if (selector === "provEmail" && /^\S+@\S+\.\S+$/.test(el.value.trim())) {
                        err.classList.add("hidden"); el.classList.remove("invalid");
                    } else if (selector === "provTel" && /^\d{10}$/.test(el.value.trim())) {
                        err.classList.add("hidden"); el.classList.remove("invalid");
                    } else if (selector !== "provEmail" && selector !== "provTel" && el.value.trim()) {
                        err.classList.add("hidden"); el.classList.remove("invalid");
                    }
                }
            };
            el.addEventListener("input", hide);
            el.addEventListener("change", hide);
        }
        ["provLinea", "provRazon", "provFiscal", "provPatios", "provFrontera"]
            .forEach(id => attachLiveHide(id, "err" + id.charAt(0).toUpperCase() + id.slice(1)));
        attachLiveHide("provEmail", "errProvEmail");
        attachLiveHide("provTel", "errProvTel");

        sectionProv?.addEventListener("input", () => {
            lockDocTab = !isProviderBasicValidSilent();
            tabDoc.disabled = lockDocTab;
        });

        function toggleSections(rol) {
            const isCorp = (rol === "Coordinador Logístico" || rol === "Administrador");
            const isProv = (rol === "Proveedor");
            sectionCorp.classList.toggle("hidden", !isCorp);
            sectionProvWrapper.classList.toggle("hidden", !isProv);
            sectionProvWrapper.setAttribute("aria-hidden", (!isProv).toString());
            const body = document.querySelector(".modal-card .modal-body");
            body.scrollTop = 0;
            if (isProv) {
                activateTab("datos");
                lockDocTab = true;
                tabDoc.disabled = true;
                document.getElementById("provLinea")?.focus({ preventScroll: true });
            } else if (isCorp) {
                document.getElementById("regNomina")?.focus({ preventScroll: true });
            }
        }

        btnOpen?.addEventListener("click", () => {
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            document.getElementById("reg-title")?.focus?.({ preventScroll: true });
            toggleSections(regRol.value || "");
            regRol?.focus?.({ preventScroll: true });
        });
        function closeModal() {
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            regForm.reset();
            resetErrors();
            toggleSections("");
        }
        document.getElementById("btnCancelReg")?.addEventListener("click", closeModal);
        document.getElementById("btnCancelReg2")?.addEventListener("click", closeModal);

        regRol.addEventListener("change", (e) => toggleSections(e.target.value));
        document.addEventListener("DOMContentLoaded", () => toggleSections(regRol.value || ""));

        regForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            resetErrors();

            const rol = regRol.value;
            if (!rol) { setErr("errRol", true); return; }

            const submitBtn = e.submitter;
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add("btn-loading");
            }

            try {
                if (rol === "Administrador" || rol === "Coordinador Logístico") {
                    const nomina = document.getElementById("regNomina").value.trim();
                    const nombre = document.getElementById("regNombre").value.trim();
                    const apellidos = document.getElementById("regApellidos").value.trim();
                    const correoOrgRaw = document.getElementById("regCorreoOrg").value.trim();
                    const correoOrg = correoOrgRaw.toLowerCase();

                    let ok = true;
                    if (!nomina) { ok = false; setErr("errNomina", true); document.getElementById("regNomina").classList.add("invalid"); }
                    if (!nombre) { ok = false; setErr("errNombre", true); document.getElementById("regNombre").classList.add("invalid"); }
                    if (!apellidos) { ok = false; setErr("errApellidos", true); document.getElementById("regApellidos").classList.add("invalid"); }
                    if (!isBDF(correoOrg)) { ok = false; setErr("errCorreoOrg", true); document.getElementById("regCorreoOrg").classList.add("invalid"); }

                    if (!ok) {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.classList.remove("btn-loading");
                        }
                        return;
                    }

                    const coll = (rol === "Administrador") ? "UsuarioAdmin" : "UsuarioLogistico";
                    const newId = await getNextId(coll);
                    await setDoc(doc(db, coll, String(newId)), {
                        id: newId,
                        rol,
                        nomina,
                        nombre,
                        apellidos,
                        correo: correoOrg,
                        estatus: "Pendiente",
                        usuario: correoOrg,
                        contrasena: null,
                        createdAt: new Date().toISOString()
                    });

                    alert("Registro enviado con éxito. Tu solicitud está pendiente de validación y se te notificará el acceso por correo electrónico.");
                    closeModal();
                }

                if (rol === "Proveedor") {
                    if (lockDocTab) {
                        const okDatos = validateProviderBasic();
                        lockDocTab = !okDatos;
                        tabDoc.disabled = lockDocTab;
                        if (lockDocTab) {
                            alert("Completa los datos de proveedor antes de adjuntar documentación.");
                            activateTab("datos");
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.classList.remove("btn-loading");
                            }
                            return;
                        }
                    }

                    const v = id => document.getElementById(id).value.trim();
                    const linea = v("provLinea");
                    const razon = v("provRazon");
                    const fiscal = v("provFiscal");
                    const patios = v("provPatios");
                    const frontera = v("provFrontera");
                    const emailRaw = v("provEmail");
                    const email = emailRaw.toLowerCase();
                    const tel = v("provTel");

                    const zip = document.getElementById("provZip")?.files?.[0];

                    let ok = validateProviderBasic();
                    if (!zip) { ok = false; setErr("errProvZip", true); }
                    else { setErr("errProvZip", false); }

                    if (!ok) {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.classList.remove("btn-loading");
                        }
                        return;
                    }

                    const newId = await getNextId("UsuarioProveedor");
                    await setDoc(doc(db, "UsuarioProveedor", String(newId)), {
                        id: newId,
                        rol: "Proveedor",
                        linea,
                        razon,
                        direccionFiscal: fiscal,
                        direccionPatios: patios,
                        frontera,
                        emailContacto: email,
                        telefonoContacto: tel,
                        estatus: "Pendiente",
                        usuario: email,
                        contrasena: null,
                        createdAt: new Date().toISOString()
                    });

                    try {
                        const zipBase64 = await readFileAsBase64(zip);

                        const response = await fetch(APPS_SCRIPT_URL, {
                          method: "POST",
                          headers: {
                            "Content-Type": "text/plain;charset=utf-8"
                          },
                          body: JSON.stringify({
                            authToken: "tk_logistica_bmm_2026",
                            action: "sendNewProviderEmail",
                            payload: {
                              providerId: newId,
                              providerEmail: email,                       
                              
                              adminEmails: [],
                        
                              zipBase64,
                              zipName: zip.name,
                        
                              providerData: {
                                linea,
                                razon,
                                direccionFiscal: fiscal,
                                direccionPatios: patios,
                                frontera,
                                telefonoContacto: tel
                              }
                            }
                          })
                        });
                        
                        // Apps Script suele responder texto; lo leemos como texto y tratamos de parsear JSON
                        const raw = await response.text();
                        let data = null;
                        try { data = raw ? JSON.parse(raw) : null; } catch (_) {}
                        
                        if (!response.ok || (data && data.success === false)) {
                          const msg = (data && (data.message || data.error)) ? (data.message || data.error) : "";
                          throw new Error(msg || `Error al llamar Apps Script (${response.status}).`);
                        }

                        alert("Registro enviado con éxito. Tu solicitud está pendiente de validación y se notificará por correo electrónico al administrador.");
                        closeModal();

                    } catch (mailErr) {
                        console.error("Error al enviar correo:", mailErr);
                        alert("Registro enviado con éxito. Tu solicitud está pendiente de validación. Ocurrió un problema al enviar la notificación por correo, pero tus datos fueron registrados.");
                        closeModal();
                    }
                }

            } catch (err) {
                console.error(err);
                setErr("regGlobalError", true, "Ocurrió un error al registrar. Intenta de nuevo.");
            } finally {
                if (e.submitter) {
                    e.submitter.disabled = false;
                    e.submitter.classList.remove("btn-loading");
                }
            }

        });

        document.addEventListener("DOMContentLoaded", () => {
            const upperInputs = document.querySelectorAll("input.upper-text");

            upperInputs.forEach(inp => {
                inp.addEventListener("input", () => {
                    const start = inp.selectionStart;
                    const end = inp.selectionEnd;

                    inp.value = inp.value.toUpperCase();
                    if (start !== null && end !== null) {
                        inp.setSelectionRange(start, end);
                    }
                });
            });
        });

    </script>
</body>


</html>
